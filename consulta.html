<!DOCTYPE html>
<html lang="pt-BR">
<head>

    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4ECDC4">
    <link rel="apple-touch-icon" href="assets/icon-192.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Consulta - Dra. Natalia Monteiro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --primary: #4ECDC4; --secondary: #FF6B6B; --bg-app: #F7F9FC;
            --card-white: #FFFFFF; --text-main: #2D3436; --text-muted: #636e72;
            --success: #34C759; --warning: #FF9500; --border: #E5E5EA;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-app); margin: 0; display: flex; flex-direction: column; height: 100vh; color: var(--text-main); }
        .top-bar-app { background: linear-gradient(135deg, var(--primary), #45b7af); padding: 30px 25px 20px 25px; color: white; display: flex; align-items: center; gap: 15px; border-radius: 0 0 25px 25px; box-shadow: 0 4px 12px rgba(78, 205, 196, 0.2); z-index: 100; }
        .btn-back-nav { background: rgba(255,255,255,0.2); border: none; color: white; width: 35px; height: 35px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .pet-header-premium { background: var(--card-white); margin: 20px; padding: 20px; border-radius: 25px; box-shadow: 0 8px 20px rgba(149, 157, 165, 0.08); border-top: 6px solid var(--primary); }
        .header-main-info { display: flex; justify-content: space-between; align-items: flex-start; }
        .pet-nome-premium h2 { margin: 0; font-size: 1.8rem; font-weight: 900; color: var(--text-main); }
        .pet-nome-premium p { margin: 2px 0; color: var(--text-muted); font-weight: 500; font-size: 0.95rem; }
        .status-badges { display: flex; flex-direction: column; gap: 6px; align-items: flex-end; }
        .badge-premium { padding: 6px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 800; display: none; align-items: center; gap: 6px; text-transform: uppercase; }
        .b-danger { background: #FFE5E5; color: var(--secondary); }
        .b-warning { background: #FFF4E5; color: var(--warning); }
        .details-grid-premium { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #F0F0F0; }
        .detail-cell span { display: block; }
        .label-p { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; }
        .val-p { font-size: 1rem; font-weight: 800; color: var(--text-main); }
        .timeline-scroll { flex-grow: 1; padding: 0 20px; overflow-y: auto; padding-bottom: 20px; }
        
        .history-card { background: var(--card-white); border-radius: 18px; padding: 15px; margin-bottom: 15px; border-left: 6px solid #DDD; box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: transform 0.2s; }
        .history-card.interativo:active { transform: scale(0.98); background: #F8F9FA; }
        
        .t-consulta { border-left-color: var(--primary); }
        .t-vacina { border-left-color: var(--success); }
        .t-exame { border-left-color: #AF52DE; }
        .t-orcamento { border-left-color: #FF9500 !important; }
        .t-recibo { border-left-color: #34C759 !important; }
        
        .footer-menu-premium { background: var(--card-white); padding: 15px 15px 30px 15px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; border-radius: 30px 30px 0 0; box-shadow: 0 -8px 25px rgba(0,0,0,0.05); }
        .action-btn-p { background: #F8F9FA; border: none; padding: 10px 2px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 0.65rem; font-weight: 800; cursor: pointer; color: var(--text-main); }
        .action-btn-p i { font-size: 1.2rem; color: var(--primary); }
        .btn-retorno { background: #FFF9F0; }
        .btn-retorno i { color: var(--warning); }
        
        .modal-sheet { display:none; position:fixed; bottom:0; left:0; width:100%; height:85%; background:white; border-radius:30px 30px 0 0; box-shadow:0 -10px 30px rgba(0,0,0,0.2); z-index:1000; padding:25px; box-sizing:border-box; overflow-y:auto; animation: slideSheet 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes slideSheet { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-input { width:100%; border:1px solid #EEE; border-radius:12px; padding:15px; font-family:inherit; margin-bottom:12px; background:#F9F9F9; outline:none; font-size:1rem; box-sizing: border-box; }
        
        .btn-flex-row { display: flex; gap: 10px; margin-top: 15px; }
        .btn-flex-col { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
    </style>
</head>
<body>

    <header class="top-bar-app">
        <button class="btn-back-nav" onclick="window.location.href='atendimento.html'"><i class="fas fa-chevron-left"></i></button>
        <h1 style="margin:0; font-size: 1.1rem; font-weight: 800; letter-spacing: 0.5px;">Atendimento</h1>
    </header>

    <div class="pet-header-premium">
        <div class="header-main-info">
            <div class="pet-nome-premium">
                <h2 id="petNome">--</h2>
                <p id="tutorNome">Carregando tutor...</p>
            </div>
            <div class="status-badges">
                <div id="badgeVacina" class="badge-premium b-danger"><i class="fas fa-syringe"></i> Vacina Atrasada</div>
                <div id="badgeBravo" class="badge-premium b-warning"><i class="fas fa-angry"></i> Animal Bravo</div>
            </div>
        </div>
        <div class="details-grid-premium">
            <div class="detail-cell"><span class="label-p">Ra√ßa</span><span class="val-p" id="petRaca">--</span></div>
            <div class="detail-cell"><span class="label-p">Idade</span><span class="val-p" id="petIdade">--</span></div>
            <div class="detail-cell"><span class="label-p">Peso</span><span class="val-p" id="petPeso">--</span></div>
        </div>
    </div>

    <div class="timeline-scroll">
        <h3 style="font-size: 0.9rem; font-weight: 800; padding: 10px 5px; color: var(--primary);">HIST√ìRICO CL√çNICO</h3>
        <p style="font-size: 0.75rem; color: #999; margin-top: -10px; margin-left: 5px;">Toque na consulta ou vacina para ver/editar.</p>
        <div id="timelineResumida">
            <p style="text-align: center; color: var(--text-muted); padding-top:20px;">Buscando dados...</p>
        </div>
    </div>

    <footer class="footer-menu-premium">
        <button class="action-btn-p" onclick="abrirModalConsultaNova()">
            <i class="fas fa-notes-medical"></i> Consulta
        </button>
        <button class="action-btn-p" onclick="window.location.href='vacinas.html?petId='+petId+'&tutorId='+tutorId">
            <i class="fas fa-syringe"></i> Vacina
        </button>
        <button class="action-btn-p" onclick="window.location.href='exame.html?petId='+petId+'&tutorId='+tutorId">
            <i class="fas fa-microscope"></i> Exame
        </button>
        <button class="action-btn-p btn-retorno" onclick="abrirModalRetorno()">
            <i class="fas fa-calendar-check"></i> Retorno
        </button>
        <button class="action-btn-p" onclick="window.location.href='financeiro.html?petId='+petId+'&tutorId='+tutorId">
            <i class="fas fa-calculator"></i> Financeiro
        </button>
        <button class="action-btn-p" onclick="window.location.href='documento.html?petId='+petId+'&tutorId='+tutorId">
            <i class="fas fa-file-alt"></i> Docs
        </button>   
        <button class="action-btn-p" onclick="registrarFoto()">
            <i class="fas fa-camera"></i> Foto
        </button>    
        <button class="action-btn-p" onclick="window.location.href='perfil_cliente.html?tutorId='+tutorId">
            <i class="fas fa-user"></i> Tutor
        </button>
    </footer>

    <div id="modalConsulta" class="modal-sheet">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 id="tituloModalConsulta" style="font-weight:900;">Nova Consulta</h3>
            <button onclick="document.getElementById('modalConsulta').style.display='none'" style="background:none; border:none; color:var(--secondary); font-weight:800;">Fechar</button>
        </div>
        <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Peso do dia (kg)</label>
        <input type="number" id="inputPesoConsulta" step="0.01" class="modal-input" placeholder="0.00">
        
        <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Anamnese e Sintomas</label>
        <textarea id="inputAnamnese" class="modal-input" style="height:100px;" placeholder="O que o pet est√° sentindo?"></textarea>
        
        <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Conduta e Tratamento</label>
        <textarea id="inputTratamento" class="modal-input" style="height:100px;" placeholder="Prescri√ß√£o e recomenda√ß√µes..."></textarea>
        
        <div class="btn-flex-row">
            <button onclick="imprimirReceita()" style="flex: 1; background:white; color:var(--primary); border:2px solid var(--primary); padding:14px 5px; border-radius:15px; font-weight:800; font-size:0.8rem;">RECEITA</button>
            <button onclick="imprimirFichaConsulta()" id="btnImprimirFicha" style="display:none; flex: 1; background:white; color:#AF52DE; border:2px solid #AF52DE; padding:14px 5px; border-radius:15px; font-weight:800; font-size:0.8rem;">FICHA</button>
            <button onclick="salvarConsulta()" id="btnSalvar" style="flex: 1.5; background:var(--primary); color:white; border:none; padding:14px 5px; border-radius:15px; font-weight:800; font-size:0.8rem;">SALVAR</button>
        </div>
    </div>

    <div id="modalVacinaDetalhe" class="modal-sheet" style="height: 65%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="font-weight:900; color: var(--success);"><i class="fas fa-syringe"></i> Detalhes da Vacina</h3>
            <button onclick="document.getElementById('modalVacinaDetalhe').style.display='none'" style="background:none; border:none; color:var(--text-muted); font-weight:800;">Fechar</button>
        </div>
        <div style="background: #F9F9F9; padding: 20px; border-radius: 15px; border: 1px solid #EEE;">
            <p style="margin: 0 0 10px 0; font-weight: 900; font-size: 1.3rem; color: var(--text-main);" id="vDetalheNome">--</p>
            <p style="margin: 5px 0; font-size: 0.95rem;"><strong>Aplica√ß√£o:</strong> <span id="vDetalheData" style="color:var(--text-muted);">--</span></p>
            <p style="margin: 5px 0; font-size: 0.95rem;"><strong>Revacina√ß√£o:</strong> <span id="vDetalheRetorno" style="color:var(--secondary);">--</span></p>
        </div>
        <div class="btn-flex-col">
            <button onclick="imprimirCertificadoVacina()" style="background:var(--success); color:white; border:none; padding:18px; border-radius:15px; font-weight:800; font-size:1rem; box-shadow: 0 4px 15px rgba(52, 199, 89, 0.3);">
                <i class="fas fa-print"></i> IMPRIMIR CERTIFICADO
            </button>
        </div>
    </div>

    <div id="modalRetorno" class="modal-sheet" style="height: 60%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="font-weight:900;">Agendar Retorno</h3>
            <button onclick="document.getElementById('modalRetorno').style.display='none'" style="background:none; border:none; color:var(--secondary); font-weight:800;">Fechar</button>
        </div>
        <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Data Sugerida</label>
        <input type="date" id="dataRetorno" class="modal-input">
        <label style="font-size:0.75rem; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Motivo</label>
        <input type="text" id="motivoRetorno" class="modal-input" placeholder="Ex: Retirar pontos...">
        <button onclick="salvarRetorno()" id="btnSalvarRetorno" style="width:100%; background:var(--warning); color:white; border:none; padding:18px; border-radius:15px; font-weight:800;">CONFIRMAR RETORNO</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/utils.js"></script>

    <script>
        var params = new URLSearchParams(window.location.search);
        var petId = params.get("petId");
        var tutorId = params.get("tutorId");
        
        var consultaEditId = null; 
        var vacinaEditData = null; 

        window.onload = carregarDados;

        async function carregarDados() {
            try {
                var tutorSnap = await db.collection("clientes").doc(tutorId).get();
                document.getElementById("tutorNome").innerText = "Tutor: " + (tutorSnap.exists ? tutorSnap.data().nome : "Desconhecido");

                var petSnap = await db.collection("clientes").doc(tutorId).collection("pets").doc(petId).get();
                if(petSnap.exists) {
                    var pet = petSnap.data();
                    document.getElementById("petNome").innerText = pet.nome;
                    document.getElementById("petRaca").innerText = pet.raca || "SRD";
                    document.getElementById("petPeso").innerText = (pet.peso_atual || "--") + " kg";
                    document.getElementById("petIdade").innerText = pet.nascimento ? Utils.calcularIdade(pet.nascimento) : "--";
                    document.getElementById("inputPesoConsulta").value = pet.peso_atual || "";

                    if (pet.comportamento === "bravo") document.getElementById("badgeBravo").style.display = "flex";
                    if (pet.data_revacina && pet.data_revacina < new Date().toISOString().split("T")[0]) {
                        document.getElementById("badgeVacina").style.display = "flex";
                    }
                }

                var hSnap = await db.collection("clientes").doc(tutorId).collection("pets").doc(petId).collection("historico").orderBy("data", "desc").limit(20).get();
                var container = document.getElementById("timelineResumida");
                container.innerHTML = "";

                hSnap.forEach(function(doc) {
                    var item = doc.data();
                    var div = document.createElement("div");
                    
                    var tipoCls = "t-consulta";
                    if (item.tipo === "vacina") tipoCls = "t-vacina";
                    else if (item.tipo === "exame") tipoCls = "t-exame";
                    else if (item.tipo === "orcamento") tipoCls = "t-orcamento";
                    else if (item.tipo === "recibo") tipoCls = "t-recibo";
                    
                    div.className = "history-card " + tipoCls;

                    if (item.tipo === "consulta") {
                        div.classList.add("interativo");
                        div.style.cursor = "pointer";
                        div.onclick = function() { abrirModalConsultaEdicao(doc.id, item); };
                    } else if (item.tipo === "vacina") {
                        div.classList.add("interativo");
                        div.style.cursor = "pointer";
                        div.onclick = function() { abrirModalDetalheVacina(item); };
                    }

                    var divCabecalho = document.createElement("div");
                    divCabecalho.style.cssText = "display:flex; justify-content:space-between; align-items:center;";

                    var tagForte = document.createElement("strong");
                    tagForte.style.fontSize = "0.75rem";
                    tagForte.innerText = (item.tipo || "Consulta").toUpperCase();
                    divCabecalho.appendChild(tagForte);

                    var divAcoes = document.createElement("div");
                    divAcoes.style.cssText = "display:flex; align-items:center; gap:12px;";

                    var spanData = document.createElement("span");
                    spanData.style.cssText = "font-size:0.75rem; color:var(--text-muted);";
                    spanData.innerText = item.data.split('T')[0].split('-').reverse().join('/');
                    divAcoes.appendChild(spanData);

                    if(item.isDocumento && item.template_gerado) {
                        var btnDoc = document.createElement("button");
                        btnDoc.innerHTML = "\x3Ci class=\x22fas fa-file-pdf\x22\x3E\x3C/i\x3E";
                        btnDoc.style.cssText = "background:none; border:none; color:var(--primary); cursor:pointer; font-size:1.1rem;";
                        btnDoc.onclick = function(e) { e.stopPropagation(); reimprimirDocumento(item.titulo_doc, item.template_gerado, item.data); };
                        divAcoes.appendChild(btnDoc);
                    }

                    if((item.tipo === "orcamento" || item.tipo === "recibo") && item.itens) {
                        var btnFin = document.createElement("button");
                        btnFin.innerHTML = "\x3Ci class=\x22fas fa-print\x22\x3E\x3C/i\x3E";
                        btnFin.style.cssText = "background:none; border:none; color:var(--warning); cursor:pointer;";
                        btnFin.onclick = function(e) { e.stopPropagation(); reimprimirFinanceiro(item); };
                        divAcoes.appendChild(btnFin);
                    }

                    if(item.tipo === "exame" && !item.isDocumento && item.link_direto) {
                        var btnE = document.createElement("button");
                        btnE.innerHTML = "\x3Ci class=\x22fas fa-eye\x22\x3E\x3C/i\x3E";
                        btnE.style.cssText = "background:none; border:none; color:#AF52DE; cursor:pointer;";
                        btnE.onclick = function(e) { e.stopPropagation(); window.open(item.link_direto, "_blank"); };
                        divAcoes.appendChild(btnE);
                    }

                    divCabecalho.appendChild(divAcoes);
                    div.appendChild(divCabecalho);

                    var pDesc = document.createElement("p");
                    pDesc.style.cssText = "margin:10px 0 0 0; font-size:0.9rem;";
                    
                    if (item.tipo === "orcamento" || item.tipo === "recibo") {
                        var listaNomes = item.itens ? item.itens.map(function(i){ return i.nome; }).join(", ") : "Servi√ßos";
                        pDesc.innerHTML = "\x3Cstrong\x3ETotal: R$ " + item.total.toFixed(2) + "\x3C/strong\x3E\x3Cbr\x3E\x3Csmall\x3E" + listaNomes + "\x3C/small\x3E";
                    } else if (item.tipo === "vacina") {
                        // O ANTIDOTO DO BUG DO UNDEFINED EST√Å AQUI:
                        var nomeV = item.nome || item.vacina || item.descricao || item.titulo || "Vacina Registrada";
                        pDesc.innerHTML = "\x3Cstrong\x3E" + nomeV + "\x3C/strong\x3E";
                    } else {
                        pDesc.innerText = item.anamnese || item.descricao || "Sem detalhes. Toque para editar.";
                    }
                    
                    div.appendChild(pDesc);
                    container.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }

        // --- SISTEMA BLINDADO DE IMPRESS√ÉO (CORRE√á√ÉO SAFARI/iOS) ---
        function gerarLayoutImpressaoSafari(conteudoPrincipal, mostrarAssinatura) {
            var dataFmt = new Date().toLocaleDateString("pt-BR", {timeZone: 'UTC'});
            var assHTML = "";
            if(mostrarAssinatura) {
                var tutorTxt = document.getElementById("tutorNome").innerText.replace("Tutor: ", "");
                assHTML = "\x3Cdiv style=\x22margin-top:60px; display:flex; justify-content:space-between;\x22\x3E" +
                          "\x3Cdiv style=\x22border-top:1px solid #000; width:45%; text-align:center; padding-top:10px; font-size:14px; margin-top:40px;\x22\x3EAssinatura do Tutor\x3Cbr\x3E" + tutorTxt + "\x3C/div\x3E" +
                          "\x3Cdiv style=\x22border-top:1px solid #000; width:45%; text-align:center; padding-top:10px; font-size:14px; margin-top:40px;\x22\x3EM√©dico(a) Veterin√°rio(a)\x3Cbr\x3ENatalia Monteiro\x3Cbr\x3ECRMV-RJ\x3C/div\x3E\x3C/div\x3E";
            }

            var htmlArr = [
                "\x3Chtml\x3E\x3Chead\x3E\x3Cstyle\x3E",
                "@page { size: A4 portrait; margin: 0; }",
                "body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }",
                ".page-a4 { position: relative; width: 100%; min-height: 100vh; box-sizing: border-box; overflow: hidden; }",
                ".bg-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; object-fit: cover; object-position: center top; }",
                ".content-wrapper { position: relative; z-index: 1; padding: 160px 50px 100px 50px; color: #2D3436; font-size: 16px; line-height: 1.6; }",
                "\x3C/style\x3E\x3C/head\x3E\x3Cbody\x3E",
                "\x3Cdiv class=\x22page-a4\x22\x3E",
                "\x3Cimg src=\x22assets/receita_bg.jpg\x22 class=\x22bg-img\x22 /\x3E",
                "\x3Cdiv class=\x22content-wrapper\x22\x3E",
                conteudoPrincipal,
                "\x3Cp style=\x22text-align:right; margin-top:40px; color: #555;\x22\x3EMag√©, " + dataFmt + "\x3C/p\x3E",
                assHTML,
                "\x3C/div\x3E\x3C/div\x3E",
                "\x3Cscript\x3Ewindow.onload=function(){ setTimeout(function(){ window.print(); window.close(); }, 800); }\x3C/script\x3E",
                "\x3C/body\x3E\x3C/html\x3E"
            ];
            
            var win = window.open("", "_blank");
            win.document.write(htmlArr.join(""));
            win.document.close();
        }

        function abrirModalConsultaNova() {
            consultaEditId = null;
            document.getElementById("tituloModalConsulta").innerText = "Nova Consulta";
            document.getElementById("inputAnamnese").value = "";
            document.getElementById("inputTratamento").value = "";
            document.getElementById("btnImprimirFicha").style.display = "none";
            document.getElementById("modalConsulta").style.display = "block";
        }

        function abrirModalConsultaEdicao(id, item) {
            consultaEditId = id;
            document.getElementById("tituloModalConsulta").innerText = "Editar Consulta";
            document.getElementById("inputPesoConsulta").value = item.peso_no_dia || "";
            document.getElementById("inputAnamnese").value = item.anamnese || "";
            document.getElementById("inputTratamento").value = item.tratamento || "";
            document.getElementById("btnImprimirFicha").style.display = "block"; 
            document.getElementById("modalConsulta").style.display = "block";
        }

        async function salvarConsulta() {
            var anam = document.getElementById("inputAnamnese").value;
            var trat = document.getElementById("inputTratamento").value;
            var novoPeso = document.getElementById("inputPesoConsulta").value;
            if(!anam) return alert("Preencha a anamnese.");
            var btn = document.getElementById("btnSalvar");
            btn.disabled = true;

            var objSalvamento = {
                anamnese: anam,
                tratamento: trat,
                peso_no_dia: novoPeso || ""
            };

            try {
                if (consultaEditId) {
                    await db.collection("clientes").doc(tutorId).collection("pets").doc(petId).collection("historico").doc(consultaEditId).update(objSalvamento);
                } else {
                    objSalvamento.tipo = "consulta";
                    objSalvamento.data = new Date().toISOString();
                    await db.collection("clientes").doc(tutorId).collection("pets").doc(petId).collection("historico").add(objSalvamento);
                }
                
                if (novoPeso) {
                    await db.collection("clientes").doc(tutorId).collection("pets").doc(petId).update({ peso_atual: novoPeso });
                }
                location.reload();
            } catch (e) { console.error(e); btn.disabled = false; }
        }

        function imprimirReceita() {
            var trat = document.getElementById("inputTratamento").value;
            if(!trat) return alert("Preencha o tratamento para gerar a receita.");
            
            var cabecalhoPaciente = "\x3Cdiv style=\x22border-bottom: 2px solid #e0c8d4; padding-bottom: 10px; margin-bottom: 20px;\x22\x3E" +
                "\x3Cp style=\x22margin: 5px 0;\x22\x3E\x3Cstrong\x3EPaciente:\x3C/strong\x3E " + document.getElementById("petNome").innerText + " &nbsp;|&nbsp; \x3Cstrong\x3ERa√ßa:\x3C/strong\x3E " + document.getElementById("petRaca").innerText + " &nbsp;|&nbsp; \x3Cstrong\x3EPeso:\x3C/strong\x3E " + document.getElementById("petPeso").innerText + "\x3C/p\x3E" +
                "\x3Cp style=\x22margin: 5px 0;\x22\x3E\x3Cstrong\x3ETutor(a):\x3C/strong\x3E " + document.getElementById("tutorNome").innerText.replace("Tutor: ", "") + "\x3C/p\x3E\x3C/div\x3E";
            
            var conteudo = cabecalhoPaciente + "\x3Cdiv style=\x22min-height: 400px; white-space: pre-wrap;\x22\x3E" + trat + "\x3C/div\x3E";
            gerarLayoutImpressaoSafari(conteudo, false);
        }

        function imprimirFichaConsulta() {
            var anam = document.getElementById("inputAnamnese").value;
            var trat = document.getElementById("inputTratamento").value;
            
            var cabecalho = "\x3Ch2 style=\x22text-align:center; color:#4ECDC4; margin-bottom:30px; text-transform:uppercase;\x22\x3EFicha Cl√≠nica de Atendimento\x3C/h2\x3E" +
                "\x3Cdiv style=\x22background:#F9F9F9; padding:15px; border-radius:10px; margin-bottom: 20px;\x22\x3E" +
                "\x3Cp style=\x22margin: 5px 0;\x22\x3E\x3Cstrong\x3EPaciente:\x3C/strong\x3E " + document.getElementById("petNome").innerText + " &nbsp;|&nbsp; \x3Cstrong\x3EPeso Medido:\x3C/strong\x3E " + (document.getElementById("inputPesoConsulta").value || "--") + " kg\x3C/p\x3E" +
                "\x3Cp style=\x22margin: 5px 0;\x22\x3E\x3Cstrong\x3ETutor(a):\x3C/strong\x3E " + document.getElementById("tutorNome").innerText.replace("Tutor: ", "") + "\x3C/p\x3E\x3C/div\x3E";
            
            var corpoAnamnese = "\x3Ch4 style=\x22color:#FF6B6B; margin-bottom:5px;\x22\x3EAnamnese / Hist√≥rico\x3C/h4\x3E\x3Cdiv style=\x22white-space: pre-wrap; margin-bottom:20px;\x22\x3E" + (anam || "Sem registro.") + "\x3C/div\x3E";
            var corpoTrat = "\x3Ch4 style=\x22color:#4ECDC4; margin-bottom:5px;\x22\x3EConduta / Tratamento\x3C/h4\x3E\x3Cdiv style=\x22white-space: pre-wrap; margin-bottom:20px;\x22\x3E" + (trat || "Sem prescri√ß√£o.") + "\x3C/div\x3E";
            
            gerarLayoutImpressaoSafari(cabecalho + corpoAnamnese + corpoTrat, true);
        }

        function abrirModalDetalheVacina(item) {
            vacinaEditData = item;
            var dataApp = item.data ? item.data.split('T')[0].split('-').reverse().join('/') : "--";
            var dataRet = item.data_revacina ? item.data_revacina.split('-').reverse().join('/') : "N√£o especificada";

            // A Rede de Seguran√ßa da Vacina ataca novamente aqui:
            var nomeV = item.nome || item.vacina || item.descricao || item.titulo || "Vacina Registrada";
            
            document.getElementById("vDetalheNome").innerText = nomeV;
            document.getElementById("vDetalheData").innerText = dataApp;
            document.getElementById("vDetalheRetorno").innerText = dataRet;
            
            document.getElementById("modalVacinaDetalhe").style.display = "block";
        }

        function imprimirCertificadoVacina() {
            if(!vacinaEditData) return;
            var v = vacinaEditData;
            var dataApp = v.data ? v.data.split('T')[0].split('-').reverse().join('/') : "--";
            var dataRet = v.data_revacina ? v.data_revacina.split('-').reverse().join('/') : "--";
            
            var nomeV = v.nome || v.vacina || v.descricao || v.titulo || "Vacina Registrada";

            var cabecalho = "\x3Ch2 style=\x22text-align:center; color:#34C759; margin-bottom:30px; text-transform:uppercase;\x22\x3ECertificado de Vacina√ß√£o\x3C/h2\x3E";
            
            var infoHtml = "\x3Ctable style=\x22width:100%; border-collapse: collapse; margin-bottom:40px;\x22\x3E" +
                "\x3Ctr\x3E\x3Ctd style=\x22padding:10px; border-bottom:1px solid #CCC;\x22\x3E\x3Cstrong\x3EPaciente:\x3C/strong\x3E " + document.getElementById("petNome").innerText + "\x3C/td\x3E\x3Ctd style=\x22padding:10px; border-bottom:1px solid #CCC;\x22\x3E\x3Cstrong\x3EEsp√©cie/Ra√ßa:\x3C/strong\x3E " + document.getElementById("petRaca").innerText + "\x3C/td\x3E\x3C/tr\x3E" +
                "\x3Ctr\x3E\x3Ctd colspan=\x222\x22 style=\x22padding:10px; border-bottom:1px solid #CCC;\x22\x3E\x3Cstrong\x3ETutor(a):\x3C/strong\x3E " + document.getElementById("tutorNome").innerText.replace("Tutor: ", "") + "\x3C/td\x3E\x3C/tr\x3E" +
                "\x3C/table\x3E";

            var destaque = "\x3Cdiv style=\x22background:#F0FFF4; padding:25px; border-radius:15px; border-left:6px solid #34C759; text-align:center;\x22\x3E" +
                "\x3Cp style=\x22margin:0; font-size:24px; font-weight:900; color:#2D3436;\x22\x3E" + nomeV + "\x3C/p\x3E" +
                "\x3Cp style=\x22margin:15px 0 0 0; font-size:18px;\x22\x3EData da Aplica√ß√£o: \x3Cstrong\x3E" + dataApp + "\x3C/strong\x3E\x3C/p\x3E" +
                "\x3Cp style=\x22margin:5px 0 0 0; font-size:18px; color:#FF6B6B;\x22\x3EPr√≥xima Dose: \x3Cstrong\x3E" + dataRet + "\x3C/strong\x3E\x3C/p\x3E" +
                "\x3C/div\x3E";

            gerarLayoutImpressaoSafari(cabecalho + infoHtml + destaque, true);
        }

        function reimprimirDocumento(titulo, texto, dataISO) {
            var cabecalho = "\x3Ch2 style=\x22text-align:center; text-transform:uppercase; margin-bottom:30px; color:#4ECDC4;\x22\x3E" + titulo + "\x3C/h2\x3E";
            var corpo = "\x3Cdiv style=\x22text-align:justify; white-space:pre-wrap;\x22\x3E" + texto + "\x3C/div\x3E";
            gerarLayoutImpressaoSafari(cabecalho + corpo, true);
        }

        function reimprimirFinanceiro(item) {
            var itensStr = "";
            if(item.itens) {
                item.itens.forEach(function(i) {
                    itensStr += "\x3Cdiv style=\x22display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:10px 0;\x22\x3E\x3Cspan\x3E" + i.nome + "\x3C/span\x3E\x3Cspan\x3ER$ " + i.valor.toFixed(2) + "\x3C/span\x3E\x3C/div\x3E";
                });
            }
            
            var cabecalho = "\x3Ch2 style=\x22text-align:center; color:#FF9500; text-transform:uppercase; margin-bottom:30px;\x22\x3E" + item.tipo + "\x3C/h2\x3E" +
                "\x3Cdiv style=\x22background:#F9F9F9; padding:15px; border-radius:10px; margin-bottom: 20px;\x22\x3E" +
                "\x3Cp style=\x22margin: 5px 0;\x22\x3E\x3Cstrong\x3EPaciente:\x3C/strong\x3E " + document.getElementById("petNome").innerText + "\x3C/p\x3E" +
                "\x3Cp style=\x22margin: 5px 0;\x22\x3E\x3Cstrong\x3ETutor(a):\x3C/strong\x3E " + document.getElementById("tutorNome").innerText.replace("Tutor: ", "") + "\x3C/p\x3E\x3C/div\x3E";
            
            var final = "\x3Cdiv style=\x22margin:30px 0;\x22\x3E" + itensStr + "\x3C/div\x3E" +
                        "\x3Cdiv style=\x22text-align:right; font-size:20px;\x22\x3E\x3Cstrong\x3ETOTAL: R$ " + (item.total||0).toFixed(2) + "\x3C/strong\x3E\x3Cbr\x3E";
            
            if(item.tipo === "recibo") {
                final += "\x3Cspan style=\x22font-size:16px; color:#34C759;\x22\x3EValor Pago: R$ " + (item.valorPago||0).toFixed(2) + "\x3C/span\x3E\x3Cbr\x3E";
                if(item.pendencia > 0) final += "\x3Cstrong style=\x22color:#FF6B6B;\x22\x3EPendente: R$ " + item.pendencia.toFixed(2) + "\x3C/strong\x3E\x3Cbr\x3E";
            }
            final += "\x3C/div\x3E";
            
            gerarLayoutImpressaoSafari(cabecalho + final, false);
        }

        async function registrarFoto() {
            var inputFoto = document.createElement("input");
            inputFoto.type = "file";
            inputFoto.accept = "image/*";
            inputFoto.capture = "environment"; 
            inputFoto.onchange = async function() {
                if (this.files && this.files[0]) {
                    const agora = new Date();
                    try {
                        await db.collection("clientes").doc(tutorId).collection("pets").doc(petId).collection("historico").add({
                            tipo: "foto", data: agora.toISOString(), descricao: "Fotografia registrada √†s " + agora.toLocaleTimeString('pt-BR')
                        });
                        carregarDados();
                    } catch (error) { console.error(error); }
                }
            };
            inputFoto.click();
        }

        function abrirModalRetorno() {
            var hoje = new Date();
            hoje.setDate(hoje.getDate() + 15);
            document.getElementById('dataRetorno').value = hoje.toISOString().split('T')[0];
            document.getElementById('modalRetorno').style.display = 'block';
        }

        async function salvarRetorno() {
            var dataR = document.getElementById("dataRetorno").value;
            var motivoR = document.getElementById("motivoRetorno").value || "Retorno de consulta";
            if(!dataR) return alert("Selecione uma data.");
            try {
                await db.collection("agenda").add({ petId, tutorId, petNome: document.getElementById("petNome").innerText, data: dataR, servico: "Retorno: " + motivoR, status: "confirmado" });
                await db.collection("clientes").doc(tutorId).collection("pets").doc(petId).collection("historico").add({ tipo: "consulta", data: new Date().toISOString(), descricao: "üìÖ Retorno agendado para o dia " + dataR.split('-').reverse().join('/') });
                alert("Retorno agendado!");
                document.getElementById('modalRetorno').style.display = 'none';
                carregarDados();
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>
